---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import Pagination from '../../components/Pagination.astro';
import { getTags, getPostsByTag, PAGE_SIZE } from '../../lib/wp';

// 预生成所有标签的静态路径
export async function getStaticPaths() {
  const tags = await getTags();
  return tags.map((t) => ({ params: { slug: t.slug } }));
}

// 标签 slug -> id
const slug = Astro.params.slug!;
const tags = await getTags();
const tag = tags.find((t) => t.slug === slug);
const tagId = tag?.id;

// 当前页（仅生成第一页，分页链接将指向 /tag/[slug]/page/[page]）
const current = 1;
const { posts, totalPages } = tagId
  ? await getPostsByTag(tagId, current, PAGE_SIZE)
  : { posts: [], totalPages: 1 };
---

<BaseLayout title={tag ? `标签：${tag.name}` : '标签未找到'} description={tag ? `包含 ${tag.count ?? 0} 篇文章` : '未找到该标签'}>
  {tag ? (
    <>
      {posts.length === 0 ? (
        <p class="text-xs antialiased opacity-60 py-1">此标签暂无文章</p>
      ) : (
        posts.map((post) => <PostCard post={post} />)
      )}
      <Pagination current={current} totalPages={totalPages} base={`/tag/${slug}/page`} />
    </>
  ) : (
    <p class="text-xs antialiased opacity-60 py-1">未找到该标签</p>
  )}
</BaseLayout>
